---
output:
  pdf_document:
    latex_engine: xelatex
    toc: true
    includes:
        before_body: title.tex
knit: (function(inputFile, encoding) {
        rmarkdown::render(inputFile, encoding = encoding, output_dir = "document_output")
      })
header-includes:
  \pagenumbering{gobble}
  \usepackage{amsmath}
bibliography: reference.bib
csl: science.csl
---

```{r setup, include=FALSE}

# setup
pacman::p_load(knitr,
               tidyverse)

knitr::opts_chunk$set(echo = FALSE,
                      message = FALSE,
                      warning = FALSE)

options(knitr.kable.NA = '')

op <- function(x, d = 2) sprintf(paste0("%1.", d, "f"), x) 

```

```{=tex}
\newpage
\pagenumbering{arabic}
```
# Supplementary text

## Sensitivity analysis

We performed a sensitivity analysis of the community simulation to identify key simulation parameters that strongly affect the relationships between community dynamics (temporal mean and SD of density) and stock enhancement. We generated 500 sets of parameter combinations by randomly drawing values of seven simulation parameters from uniform distributions (**Table S1**). For each parameter combination, we simulated dynamics of 100 independent communities with varying numbers of stock enhancement $R$ (drawn randomly from $Unif(0, 500)$). This yields a total of $5 \times 10^4$ simulation replicates. In each simulation replicate, we ran 1600 time steps of community dynamics and obtained temporal means and SDs of the whole community ($\sum_i^SN_i$), enhanced species ($N_1$), and unenhanced species ($\sum_{i, i\ne1}^SN_i$) using the last 1000 time steps. The first 600 time steps were discarded as initialization and burn-in periods.

For each parameter combination, we estimated Spearman's rank correlation $\xi$ between the number of releases $R$ and community dynamics, which indicate the effect of stock enhancement under a given ecological context. To examine influences of simulation parameters on $\xi$ (**Table S1**), we developed the following regression model taking $\xi$ as a response variable:

$$
\begin{aligned}
  \xi_{n} &\sim Normal(\mu_n, \sigma^2)\\
  \mu_n &= \zeta_0 + \zeta_1 S_n + \zeta_2 r_{1,n} + \zeta_3 r_{max,n} + \zeta_4  \bar{\alpha}_n + \zeta_5 K_n + \zeta_6 \sigma_{\epsilon,n} + \zeta_7 f_{R, n}
\end{aligned}
$$

where $\xi_n$ is Spearman's rank correlation for parameter combination $n$, and $\zeta_k$ ($k = 0-7$) are the intercept ($\zeta_0$) and regression coefficients ($\zeta_{1-7}$). Explanatory variables were standardized (mean = 0, SD = 1) to compare regression coefficients.

We found that regression coefficients of the following parameters ($\zeta$) never exceeded a value of 0.10: the number of species $S$, maximum intrinsic growth rate of unenhanced species $r_{max}$, environmental stochasticity $\sigma_{\epsilon}$, and relative fitness $f_R$. Therefore, these parameters have little influence on the qualitative relationship between the number of releases and community dynamics. In the main simulation, we fixed values of $S$, $r_{max}$, and $\sigma_{\epsilon}$ (**Table S1**). In the meantime, we varied values of $K$, $r_1$, $f_R$, and $\bar{\alpha}$ as they are potentially influential (**Table S1**). Although $f_R$ had little influence on stocking effects (**Table S1**), we varied this parameter given the significant interest in the relative fitness of captive-bred individuals in the wild.

\newpage

# Tables

## Table S1 Simulation parameter

Parameter values used in the main and sensitivity analysis. Five hundred parameter values were drawn randomly from uniform distributions in the sensitivity analysis.

```{r table_s1}

# Table S1
source(here::here("code/table_param_set.R"))
kable(df_param, format = "markdown")

```

\newpage

```{r data_stvy, include=FALSE}

# Table S2-4
## load table for sensitivity analysis
source(here::here("code/table_stvy_analysis.R"))

```

```{r table_sensitivity, results="asis"}

# Table S2-4
j <- 1

## conditional text
c_text <- c("whole community",
            "enhanced species",
            "unenhanced species")

table_stvy_chunk <- knit_chunk <- NULL

for(i in 1:length(table_stvy)) {
  
  table_legend <- paste0("Sensitivity analysis of the community simulation. Parameter estimates of linear regression models (standard errors in parenthesis) are shown. Response variables are Spearman's rank correlation between stock enhancement and either temporal mean density ($\\mu$) or SD ($\\sigma$) of ", c_text[i],". Explanatory variables (i.e., simulation parameters) were standardized (mean = 0, SD = 1) before the analysis.")
  
  knit_chunk <- paste0("## Table S", i + j, " Sensitivity analysis (", c_text[i],") \n",
                       table_legend,
                       "\n```{r table_s", i + j,", results='asis'}
                       \n\n
                       cat(table_stvy[[", i,"]], sep = '\n')
                       \n\n
                       ```\n",
                       "\n\\pagebreak\n")
  
  table_stvy_chunk <- c(table_stvy_chunk, knit_chunk)  
  
}

```

`r paste(knit(text = table_stvy_chunk), collapse = '\n')`

## Table S5 Observed species

Fish species found in the study watersheds.

```{r table_s5}

# Table S5
source(here::here("code/table_species_list.R"))

kable(df_sp_list,
      format = "markdown")

```

\newpage

## Table S6 Priors

Prior distributions used in the Bayesian models.

```{r table_s6}

# Table S6
source(here::here("code/table_prior.R"))

kable(df_prior,
      format = "markdown")

```

\newpage

## Table S7 Parameter estimates of the Bayesian state-space model

Median estimates of the Bayesian state-space model. Numbers in parenthesis indicate 95% credible intervals. Site-specific parameters were excluded due to a large number of parameters.

```{r table_s7}

# Table S7
source(here::here("code/table_ssm.R"))

kable(df_ssm,
      align = c(rep("l", 3), "c"),
      format = "markdown")

```

\newpage

```{r table_reg}

# Table S8-10
## load regression tables
source(here::here("code/table_reg.R"))
j <- 7

## conditional text
c_text <- case_when(name == "all" ~ "whole community",
                    name == "masu" ~ "masu salmon",
                    name == "other" ~ "unenhanced species")

## common text
table_legend <- "Median estimates and standard errors (SEs) of regression coefficients are shown. Pr(> 0) and Pr(< 0) represent the proportion of positive and negative estimates in MCMC samples, respectively (i.e., posterior probability)."

table_reg_chunk <- knit_chunk <- NULL

for(i in seq_len(length(df_est))) {
  
  knit_chunk <- paste0("## Table S", i + j, " Parameter estimates for the regression model (", c_text[i], ") \n",
                       table_legend,
                       "\n```{r table_s", i + j,"}
                       \n\n
                       kable(df_est[[",i,"]],
                             align = c(rep('l', 3), rep('c', 4)),
                             format = 'markdown')
                       \n\n
                       ```\n",
                       "\n\\pagebreak\n")

  table_reg_chunk <- c(table_reg_chunk, knit_chunk)
  
}


```

`r paste(knit(text = table_reg_chunk), collapse = '\n')`

# Figures

```{r figure_sim}

# Figure S1-6
## load figures
source(here::here("code/figure_si_theory.R"))

j <- 0
figure_sim_chunk <- knit_chunk <- NULL

for(i in seq_len(nrow(df_param))) {
  
  knit_chunk <- paste0("## Figure S", i + j,
                       " Theoretical prediction (",
                       "$r_1$ = `r df_param$r1[",i,"]`, ",
                       "$K$ = `r df_param$k[",i,"]`) \n",
                       
                       "\n```{r figure_s", i + j,", fig.width = 9.5, fig.height = 8}
                       \n\n
                       list_g_theory[[",i,"]]
                       \n\n
                       ```\n",
                       
                       "Theoretical predictions for the stocking effect on community dynamics. Rows represent different response variables, and columns show distinct simulation scenarios with different strength of interspecific competition ($\\bar{\\alpha}$) and relative fitness of captive-bred individuals ($f_R$). Other parameters are: ",
                       "number of species $S$ = `r df_param$n_species[",i,"]`; ",
                       "intrinsic growth rate of an enhanced species $r_1$ = `r df_param$r1[",i,"]`; ",
                       "maximum intrinsic growth rate of unenhanced species $r_{max}$ = `r df_param$r_max[",i,"]`; ",
                        "environmental stochasticity $\\sigma_{\\epsilon}$ = `r df_param$sd_env[",i,"]`; ",
                        "carrying capacity $K$ = `r df_param$k[",i,"]`.",
                        "\n\\pagebreak\n")

  figure_sim_chunk <- c(figure_sim_chunk, knit_chunk)
  
}

```

`r paste(knit(text = figure_sim_chunk), collapse = '\n')`

```{r figure_dyns}

# Figure S7-9
## load figures
source(here::here("code/figure_si_obs_dyns.R"))
j <- 6

c_text <- c("whole community",
            "masu salmon",
            "unenhanced species")

figure_dyns_chunk <- knit_chunk <- NULL

for(i in seq_len(length(list_g_dyns))) {
  
  knit_chunk <- paste0("## Figure S", i + j,
                       " Temporal dynamics of stream fish communities (`r c_text[",i,"]`) \n",
                       
                       "\n```{r figure_s", i + j,", fig.width = 11, fig.height = 11}
                       \n\n
                       list_g_dyns[[",i,"]]
                       \n\n
                       ```\n",
                       "Temporal dynamics of stream fish communities (`r c_text[",i,"]`) in Hokkaido, Japan. Dots represent observed density, and solid lines are the predicted values of the Bayesian state-space model. Panels correspond to individual watersheds, and colors distinguish sampling sites within a watershed.",
                        "\n\\pagebreak\n")

  figure_dyns_chunk <- c(figure_dyns_chunk, knit_chunk)
  
}

```

`r paste(knit(text = figure_dyns_chunk), collapse = '\n')`

\newpage

## Figure S10 Environmental variables

```{r figure_s10, fig.width=11, fig.height=8}

source(here::here("code/figure_si_env.R"))

print(g_env)
```

Distribution of environmental variables in the protected watershed. Note that the number of fish released and ocean productivity (chlorophyll *a*) are measured at the watershed level while others are measured at the site level.

\newpage

## Figure S11 Correlation plot

```{r figure_s11, fig.width=11, fig.height=11}

source(here::here("code/figure_si_cor.R"))
```

Correlation plot among environmental variables in the protected watersheds. Numbers indicate Spearman's rank correlations.
