---
output:
  bookdown::pdf_document2:
    latex_engine: xelatex
    toc: true
    includes:
        before_body: title.tex
mainfont: "Times New Roman"
fontsize: 11pt
knit: (function(inputFile, encoding) {
        rmarkdown::render(inputFile,
                          encoding = encoding, 
                          output_dir = "document_output")
      })
header-includes:
  - \pagenumbering{gobble}
  - \usepackage{amsmath}
bibliography: reference.bib
csl: https://www.zotero.org/styles/pnas
---

```{r setup, include=FALSE}

# setup ####
source(here::here("code/library.R"))
source(here::here("code/set_functions.R"))

knitr::opts_chunk$set(echo = FALSE,
                      message = FALSE,
                      warning = FALSE)

options(knitr.kable.NA = '')


# theory ####
cols <- c(
  "n_species",
  "k",
  "r_type",
  "r1",
  "r_min",
  "r_max",
  "sd_env",
  "phi",
  "int_type",
  "alpha",
  "model",
  "seed")

list_sim <- list(readRDS(here::here("output/result_ricker_2sp.rds")),
                   readRDS(here::here("output/result_ricker.rds")))

list_param <- list_sim %>% 
  lapply(FUN = function(x) {
      n_sim <- x %>% 
        mutate(n_sim = n_warmup + n_burnin + n_timestep) %>% 
        pull(n_sim) %>% 
        unique()
      
      param_set <- x %>% 
        dplyr::select(which(colnames(x) %in% cols)) %>% 
        distinct()
      
      attr(param_set, "n_sim") <- n_sim
      return(param_set)
  })

# empirical data ####

## raw data
source(here::here("code/data_fmt_fishdata.R"))
source(here::here("code/data_fmt_reg.R"))

df_area <- d0 %>% 
  group_by(site_id, year) %>% 
  summarize(area = unique(area))

## ssm estimate
df_bp <- list.files(path = here::here("data_fmt"),
                    full.names = T,
                    pattern = "joint") %>% 
  readRDS() %>% 
  filter(param == "bp_value") %>% 
  dplyr::select(mean)

## mcmc sample size
df_mcmc_ssm <- list.files(path = here::here("data_fmt"),
                    full.names = T,
                    pattern = "joint") %>% 
  readRDS() %>% 
  ungroup() %>% 
  dplyr::select(n_total_mcmc,
                n_sample,
                n_thin,
                n_burn) %>% 
  distinct()

df_mcmc_reg <- list.files(path = here::here("output"),
                          full.names = T,
                          pattern = "summary_reg") %>% 
  readRDS() %>% 
  dplyr::select(n_total_mcmc,
                n_sample,
                n_thin,
                n_burn) %>% 
  distinct()

## release data
source(here::here("code/data_fmt_stock.R"))

df_stock_stage <- df_stock %>% 
  group_by(release_stage) %>% 
  summarize(stock = sum(abundance)) %>% 
  mutate(ratio = stock / max(stock),
         prop = stock / sum(stock))

```

```{=tex}
\newpage
\pagenumbering{arabic}
```
# Methods

## Theory

### Model

We employed a multispecies Ricker model [@fowlerSpeciesDynamicsAlter2012]. In the basic formula without intentional release, the population density of species $i$ at time $t+1$, $N_{i,t+1}$, is modeled as:

```{=tex}
\begin{align}
N_{i,t+1} = N_{i,t}~\exp\left[r_i \left(1-\frac{\sum_{j=1}^S \alpha_{ij}N_{j,t}}{K_i} \right) \right]\exp(\varepsilon_{i,t})
\end{align}
```
where $r_i$ is the intrinsic growth rate, $\alpha_{ij}$ the competition coefficient of species $j$ on $i$, $K_i$ the carrying capacity, and $\varepsilon_{i,t}$ the species response to stochastic environmental fluctuations that obey an normal distribution $\text{Normal}(0, \sigma_{\varepsilon}^2)$. We modified this formula to include the effects of intentional release (species 1) on reproduction and competition as follows:

```{=tex}
\begin{align}
N_{i,t+1} = (N_{i,t}+\phi_i R_t)~\exp \left[r_i \left\{1-\frac{\alpha_{i1} (N_{1,t} + R_t) + \sum_{j=2}^S \alpha_{ij}N_{j,t}}{K_i} \right\} \right]\exp(\varepsilon_{i,t})
(\#eq:ricker)
\end{align}
```
$R_t$ is the number of released individuals, and the parameter $\phi_i$ controls the relative fitness of captive-bred individuals:

```{=tex}
\begin{align}
\phi_i = 
\left\{
\begin{array}{cc}
f_R & (i = 1)\\
0 & (i \ne 1)
\end{array}
\right.
\end{align}
```
$f_R~(\ge 0)$ is the density-independent survival of captive-bred individuals relative to wild individuals. Equation \@ref(eq:ricker) can be reorganized to:

```{=tex}
\begin{align}
N_{i,t+1} = (N_{i,t}+\phi_i R_t) ~ \exp \left[r_i \left(1-\frac{\alpha_{i1}R_t + \sum_{j=1}^S \alpha_{ij}N_{j,t}}{K_i} \right) \right]\exp(\varepsilon_{i,t})
\end{align}
```
In this model, intrinsic growth rates of unenhanced species $r_{i,i \ne 1}$ and interspecific competition $\alpha_{ij}$ are random draws from a uniform ($r_{i,i \ne 1} \sim \text{Unif}(0.5,r_{max})$) and an exponential distribution ($\alpha_{ij} \sim \text{Exp}(1/\bar{\alpha})$), respectively. We assumed constant values of intraspecific competition ($\alpha_{ii}=1$), carrying capacity $(K_i = K)$ and the number of releases $(R_t=R)$.

### Model analysis

First, we analyzed a two-species community to gain insights into the model behavior and to guide the N-species analysis. Specifically, we examined the release effect with $20$ parameter values of intrinsic population growth rate $r_i$ ($0.5$ to $3.5$ with an equal interval) and carrying capacity $K$ ($50$ to $500$ with an equal interval), resulting in $400$ parameter combinations. In a single-species Ricker model, the chosen range of $r_i$ can generate stable equilibrium, damped oscillations, limit cycle, and chaos (XXX). For simplicity, we assumed $r_1 = r_2$. We crossed this parameter setup with environmental stochasticity ($\sigma_{\varepsilon} =$ `r unique(list_param[[1]]$sd_env)`) and competition strength ($\alpha_{ij} =$ `r unique(list_param[[1]]$alpha)`) and generated `r nrow(list_param[[1]])` simulation scenarios ($400 \times 2 \times 2$).

Under each simulation scenario, we ran `r attr(list_param[[1]], "n_sim")` time steps of community dynamics for $100$ values of release level $R$ (0 to 500 with an equal interval). We introduced 50 individuals of each species and allowed them to grow with no intentional release for the first `r unique(list_sim[[1]]$n_warmup)` time steps (initialization). After the initialization period, we released $R$ individuals of the enhanced species every time step over the next `r unique(list_sim[[1]]$n_burnin)` time steps to reach new equilibrium with intentional release (burn-in period). We continued the simulation run with intentional release and saved the last `r unique(list_sim[[1]]$n_timestep)` time steps, which were used to obtain the following summary statistics of the whole community $\sum_i^S N_i$: the coefficient of variation (CV), the temporal mean ($\mu$), and the SD ($\sigma$).

We subsequently analyzed a whole community model with 10 species using important parameter combinations identified in the two-species simulation: intrinsic growth of enhanced species ($r_1 =$ `r unique(list_param[[2]]$r1)`), average strength of interspecific competition ($\bar{\alpha}=$ `r unique(list_param[[2]]$alpha)`), carrying capacity ($K=$ `r unique(list_param[[2]]$k)`). We confirmed that these parameters were influential in the ten-species community model via sensitivity analysis (**Table S2 -- S4**). We also varied relative fitness of captive-bred individuals ($f_R=$ `r unique(list_param[[2]]$phi)`) as this is a common interest in captive-breeding programs. Meanwhile, we fixed values of the following parameters: the number of species ($S=$ `r unique(list_param[[2]]$n_species)`), maximum intrinsic growth rate of unenhanced species ($r_{max}=$ `r unique(list_param[[2]]$r_max)`), and environmental stochasticity ($\sigma_{\varepsilon}=$ `r unique(list_param[[2]]$sd_env)`). This simulation setup resulted in `r nrow(list_param[[2]])` sets of parameter combinations.

As with the two-species model, we ran `r attr(list_param[[2]], "n_sim")` time steps of community dynamics with `r max(list_sim[[2]]$n_rep)` values of release level $R$ ($0$ to $500$ with a constant interval) for each simulation scenario. In this simulation, we initialized the community by introducing five individuals of each species and repeated this seeding every 10 time steps to account for possible complex dynamics of a ten-species community. The rest of the simulation procedure is identical to the two-species model. We summarized values of simulation parameters in **Table S1**.

## Empirical analysis

### Data

**Time-series data.** We assembled time-series fish data at `r n_distinct(d0$site_id)` sites within `r n_distinct(d0$river)` protected watersheds of Hokkaido Island, Japan. The Hokkaido Research Organization leads a long-term monitoring program at these watersheds, and the data are published as annual reports [@salmonandfreshwaterfisheriesresearchinstitutehokkaidoresearchorganizationAnnualReportMonitoring2021]. The program began in 1963, but an effective, standardized sampling method has been implemented since 1999 (two-pass sampling with a combination of electrofishing and cast net). Most data were collected in summer with irregular interannual intervals (1- to 3-year intervals for most cases), and sampling efforts were quantified by sampling area (average: `r op(mean(df_area$area))` $\pm$ `r op(sd(df_area$area))` m^2^). We confined our analysis to the sites that meet the following criteria: (i) the observation span (from the first to the last year of observation) exceeds 10 years, (ii) the number of observation years exceeds five years, and (iii) masu salmon is observed at least twice during the observation period. As a result, we used time-series data at `r n_distinct(df_fish$site_id)` sites within `r n_distinct(df_fish$river)` watersheds from 1999 to 2019. Summed abundance of first and second passes was used in the following analysis. **Table S5** summarizes observed species in these watersheds.

**Fish release.** The release of masu salmon began in the 1950s. Hatchery fish are released in spring (fry and smolt stages) and fall (juvenile stage). Although the fish release occurs at multiple locations within a watershed, the release information is available only at the watershed level. For each release stage, we assembled annual records of intentional release (the number of fish released; 1999-2019) from annual investigations by the Japan Fisheries Research and Education Agency and Salmon and Freshwater Fisheries Research Institute. During the study period, the majority of release took place in spring at a fry stage (fry : juvenile : smolt = `r pull(df_stock_stage, ratio)[1]` : `r op(pull(df_stock_stage, ratio)[2])` : `r op(pull(df_stock_stage, ratio)[3])`)

**Environmental data.** At each sampling site, we measured the following environmental variables as potential covariates: upstream watershed area (km^2^; a proxy for stream size), proportional land use in the upstream watershed (forest, urban, agriculture), local climates (annual mean air temperature [$^\circ C$] and cumulative precipitation [mm]), and ocean productivity (sea surface chlorophyll *a* concentration [mg m^-3^]). We used MERIT Hydro [@yamazakiMERITHydroHighresolution2019] to delineate the upstream watershed polygon for each sampling site. We estimated the proportion of forest, urban, and agriculture in each watershed polygon based on land use data in 2015 from Copernicus Global Land Service (100-m resolution) [@marcelbuchhornCopernicusGlobalLand2020]. Climate data at each sampling site were extracted from CHELSA version 1.2 [@kargerClimatologiesHighResolution2017; @kargerDataClimatologiesHigh2018]. We extracted annual data of chlorophyll *a* concentration (2002 -- 2019; resolution, 4.6 km^2^) from OceanColor [@seawifsmissionpageNasaOceanBiology2019] as a proxy for ocean productivity and calculated the average value within the 30-km radius of each river mouth. We used the following R packages to perform geospatial analysis: *sf* [@pebesmaSimpleFeaturesStandardized2018]*, raster* [@hijmansRasterGeographicData2020]*, exactextractr* [@bastonExactextractrFastExtraction2020]*, stars* [@pebesmaStarsSpatiotemporalArrays2020]*, whitebox* [@lindsayWhiteboxGATCase2016]*.*

### Statistical analysis

**Community dynamics comparison.** Our goal is to compare temporal community dynamics across sites. However, the data are not comparable because of observation errors (e.g., different observers) and missing observations. To confront this challenge, we developed a Bayesian state-space model for two species groups separately: (i) enhanced species, the abundance of masu salmon, and (ii) unenhanced species, the summed abundance of all species except masu salmon. A Bayesian state-space model is best suited for our analysis because it can account for observation errors while imputing missing values given the long-term trend at each site [@clarkPopulationTimeSeries2004; @keryBayesianPopulationAnalysis2012]. The model is composed of observation and state models, as described below.

In the observation model, we model observation processes. Fish abundance at site $s$ in year $t$ (either enhanced or unenhanced species), $N_{s,t}$, was assumed to follow a Poisson distribution:

```{=tex}
\begin{align}
N_{s,t} \sim \text{Poisson}(\lambda_{s,t} A_{s,t})
\end{align}
```
where $\lambda_{s,t}$ is the expected fish density (individual m^-2^) and $A_{s,t}$ the sampling area (m^2^). Since fish sampling was conducted after the spring release of masu salmon, captured fish may include individuals released in the observation year. We explicitly modeled this observation process to avoid biases in estimating temporal community trends:

```{=tex}
\begin{align}
\lambda_{s,t} = n_{s,t}\exp(\varepsilon_{s,t}^{\text{obs}}) + \psi \beta_s~Fry_{w(s),t}
\end{align}
```
$n_{s,t}$ is the "true" fish density excluding fish released in the spring, $Fry_{w(s),t}$ the number of salmon fry released (unit: million fish) in spring in watershed $w$ within which site $s$ is located, and $\beta_s$ the site-specific effect of released salmon fry on the observed fish density. The parameter $\beta_s$ was drawn from a normal distribution with the hyper-mean $\mu_{\beta}$ and hyper-variance $\sigma_{\beta}^2$. The parameter $\varepsilon_{s,t}^{\text{obs}}$ is the error term that follows a normal distribution $\text{Normal}(0, \sigma_{\text{obs},s}^2)$. The inclusion of this term allows the model to account for site- and year-specific observation errors, which can be caused by ecological and/or artificial factors. When modeling the unenhanced species group, $\psi$ equals zero (otherwise $\psi = 1$) so the model excludes the term $\beta_s~Fry_{w(s),t}$.

In the state model, we model temporal dynamics of fish density $n_{s,t,g}$ as follows:

```{=tex}
\begin{align}
\begin{split}
&\ln n_{s,t} = \nu_{1,s} + \nu_{2,s} \ln n'_{s,t-1} + \varepsilon_{s,t}^{\text{state}}\\
&\ln n'_{s,t-1} = \frac{\sum_{q=1}^Q (\tau^{q} \ln n_{s,t-q})}{\sum_{q=1}^Q \tau^{q}}
\end{split}
(\#eq:state)
\end{align}
```
where $\nu_{1,s}$ is the site-specific growth rate at site $s$, $\nu_{2,s}$ the parameter characterizing density-dependence, and $\varepsilon_{s,t}^{\text{state}}$ the process error that follows a normal distribution as $\varepsilon_{s,t}^{\text{state}} \sim \text{Normal}(0, \sigma_{\text{state},s}^2)$. The parameters $\nu_{1,s}$ and $\nu_{2,s}$ were drawn from a multi-variate normal distribution as $\pmb{\nu} \sim \text{MVN}(\pmb{\theta_{\nu}}, \pmb{\Omega_{\nu}})$, where $\pmb{\nu}$ is the matrix of $\nu_{1,s}$ and $\nu_{2,s}$. Equation \@ref(eq:state) is structurally equivalent to a $Q$-order autoregressive (AR) model; however, our model has only one AR parameter $\tau$ (range: 0 -- 1) unlike ordinary AR models that require $Q$ AR parameters. This reduction of parameter numbers is possible because we express the AR parameters as a geometric-series $\tau^q$. Thus, the parameter $\tau$ controls how fast the density influence attenuates towards the past. In this study, we set $Q=3$ given the life span of the study species (typically 1 -- 3 years). We used median estimates of fish density $n_{s,t}$ to calculate the temporal CV, mean ($\mu$), and SD ($\sigma$) for each site. For a whole community, we summed the densities of enhanced and unenhanced species. We summarized the reconstructed community dynamics in **Figures S7 -- S9**.

We assessed the predictive performance of our model using the Bayesian p-value [@keryIntroductionWinBUGSEcologists2010], a value of which takes a range of 0 --1 and indicates over- (\~0.00), under- (\~1.00), or suitable-fitting (\~0.50) to the data. A Bayesian p-value for our state-space models was `r op(min(df_bp$mean))`, indicating that our model specification is appropriate.

We used linear regression to quantify the impact of intentional release on community dynamics. Although our focus is intentional release, each model included climatic and local abiotic variables to account for important environmental differences among sites. Specifically, we developed the following linear regression model taking either species richness (the number of species present during the observation period), mean, or SD as a response variable $y_s$.

```{=tex}
\begin{align}
\left\{
\begin{aligned}
y_s &\sim \text{Poisson}(\lambda_{y,s} \exp(\varepsilon_{\lambda,s})) &&\text{for species richness}\\
\ln \pmb{y_s} &\sim \text{MVN}(\pmb{\theta_{y,s}}, \pmb{\Omega_y}) &&\text{for mean and SD}
\end{aligned}
\right.
 (\#eq:reg)
\end{align}
```
In the poisson model for species richness, $\exp(\varepsilon_{\lambda,s})$ is the error term accounting for overdispersion ($\varepsilon_{\lambda,s} \sim \text{Normal}(0, \sigma_{\lambda}^2)$). In the multi-variate normal model, $\pmb{y_s}$ represents a vector of mean and SD at site $s$, which is modeled as a random variable drawn from a multi-variate normal distribution with the variance-covariance matrix $\pmb{\Omega_y}$. The expected means $\lambda_{y,s}$ and $\pmb{\theta_s}$ were related to linear predictors as follows:

```{=tex}
\begin{align}
\left\{
\begin{aligned}
\ln \lambda_{y,s} &= \gamma_{0,w(s)} + \gamma_1 R'_{s} + \sum_k \gamma_kx_{k,s} &&\text{for species richness}\\
\theta_{y,s} &= \gamma_{0,w(s)} + \gamma_1 R'_{s} + \sum_k \gamma_k x_{k,s} &&\text{for mean and SD}
\end{aligned}
\right.
(\#eq:model)
\end{align}
```
$\gamma_{0,w(s)}$ is the watershed-specific intercept ($w(s)$ refers to site $s$ nested within watershed $w$) and $\gamma_k (k > 0)$ is the $k^\text{th}$ regression coefficient [effective release of masu salmon $R'_s$ ($k = 1$) and other site-level predictors $x_k$ ($k \ge 2$)]. $R'_s$ is the product of the average yearly release at watershed $w$ ($R_w$; fry + juvenile + smolt, averaged for 1999 -- 2019) and the site-specific weight factor $\eta_{w,s'}$ ($s'=1,...,S_w + 1$, where $S_w$ is the number of sites within watershed $w$):

```{=tex}
\begin{align}
\begin{split}
R'_s &= \eta_{w,s'} R_w\\
\sum_{s'}^{S_w + 1} \eta_{w,s'} &= 1
(\#eq:effr)
\end{split}
\end{align}
```
In Equation \@ref(eq:effr), $\eta_{w,s'}$ represents the effective proportion of total release affecting the community at site $s'$ within watershed $w$. The summation of $\eta_{w,s'}$ over $S_w+1$ is assumed to be a unity because non-negligible portion of release may escape into unsurveyed areas. Since the values of $\eta_{w,s'}$ are not available in our dataset, we estimated them through a stochastic search while fitting the regression model to the data within a Bayesian framework (see **Model fitting**). Other site-level predictors include upstream watershed area (log-transformed), air temperature, precipitation, and forest land use. Urban and agricultural land use were omitted because of either a limited value range (**Figure S10**) or a strong correlation with forest land use (**Figure S11**). The watershed-specific intercept was related to watershed-level predictors as:

```{=tex}
\begin{align}
\begin{split}
\gamma_{0,w} &\sim \text{Normal}(\mu_{\gamma,w},\sigma_{\gamma}^2)\\
\mu_{\gamma,w} &= \delta_0 + \delta_1 z_{w}
\end{split}
\end{align}
```
$\delta_{0}$ is the global intercept and $\delta_1$ is the regression coefficient of ocean productivity $z_{w}$ (chlorophyll *a* concentration; averaged for 2002 -- 2019). Ocean productivity was included because the majority of the observed species use marine habitats at a certain life stage (i.e., diadromous). The parameter $\sigma_{\gamma}$ accounts for random variation among watersheds that the watershed-level predictors cannot capture.

Since the CV is a additive function of mean $\mu$ and SD $\sigma$ in a log scale, we can derive the effects of environmental factors on the CV from Equation \@ref(eq:model):

```{=tex}
\begin{align}
\text{E}(\ln CV_s) = \text{E}(\ln y_s^{(\sigma)}) - \text{E}(\ln y_s^{(\mu)})
\end{align}
```
Considering that $\text{E}(\ln y_s^{(\sigma)}) = \theta_{y,s}^{(\sigma)}$ and $\text{E}(\ln y_s^{(\mu)}) = \theta_{y,s}^{(\mu)}$,

```{=tex}
\begin{align}
\text{E}(\ln CV_s) = (\gamma_{0,w(s)}^{(\sigma)} - \gamma_{0,w(s)}^{(\mu)}) + (\gamma_{1}^{(\sigma)} - \gamma_{1}^{(\mu)})R'_s + \sum_k (\gamma_{k}^{(\sigma)} - \gamma_{k}^{(\mu)})x_{k,s}
\end{align}
```
All predictors were standardized (mean = 0, SD = 1) before the analysis.

**Species interaction.** We analyzed a subset of our data to estimate the strength of interspecific interactions among stream fishes. In this analysis, we focused on `r n_distinct(df_complete$site_id)` sites with (1) \> 16 years of observations and (2) no intentional release of masu salmon. These additional constraints were necessary to estimate parameters in a complex multi-species model within a state-space modeling framework.

We fitted the following state-space model to the data for each site separately. In the observation model, we modeled fish abundance $N_{i,t}$ for species $i$ at year $t$ as:

```{=tex}
\begin{align}
\begin{split}
N_{i,t} \sim \text{Poisson}(\lambda_{i,t} A_{t})\\
\lambda_{s,t} = n_{i,t}\exp(\varepsilon_{i,t}^{\text{obs}})
\end{split}
\end{align}
```
In the state model, we described a multi-species Ricker model for fish density $n_{i,t}$:

```{=tex}
\begin{align}
\ln n_{i,t} = \ln n_{i,t-1} + r_{i} - \sum_{j=1}^S\alpha'_{ij} n_{i,t-1} + \varepsilon_{i,t}^{\text{state}}
(\#eq:ricker-ssm)
\end{align}
```
Equation \@ref(eq:ricker-ssm) is equivalent to Equation \@ref(eq:ricker) except the scale of competition coefficients $\alpha'_{ij}$ ($\frac{\alpha'_{ij}}{\alpha'_{ii}}=\alpha_{ij}$, where $\alpha'_{ii}=\frac{r_i}{K_i}$). We used sparse priors for $\alpha'_{ij}$ to reduce the risk of over-fitting [@mutshindaWhatDrivesCommunity2009]:

```{=tex}
\begin{align}
\begin{split}
\alpha'_{ij} \sim \text{half-Normal}(0, \sigma^2_{\alpha, ij})\\
\sigma_{\alpha,ij}^2 = z_{ij}c_1 + (1-z_{ij})c_0
\end{split}
(\#eq:sparse)
\end{align}
```
In Equation \@ref(eq:sparse), the latent variable $z_{ij}$ is drawn from a Bernoulli distribution and controls the prior for $\alpha'_{ij}$. We used $c_1 = 1$ and $c_0 = 0.01$ so that $\alpha'_{ij}$ is freely estimated when $z_{ij}=1$ ($\sigma^2_{\alpha} = 1$). Otherwise, the probability density of $\alpha'_{ij}$ would be concentrated around zero ($\sigma^2_{\alpha} = 0.01$), effectively omitting the parameter from the model [@mutshindaWhatDrivesCommunity2009]. We assigned different "inclusion" probabilities to diagonal (intraspecific competition) and off-diagonal elements (interspecific competition) as $z_{ii} \sim \text{Bernoulli}(p_{\alpha}^{\text{intra}})$ and $z_{ij,i \ne j} \sim \text{Bernoulli}(p_{\alpha}^{\text{inter}})$.

We assumed that environmental noise $\varepsilon_{i,t}^{\text{state}}$ is correlated among species by introducing the variance-covariance matrix $\pmb{\Omega_{\varepsilon}}$. The matrix $\pmb{\Omega_{\varepsilon}}$ was modeled with the aid of latent factors $\zeta_{t,d}$ and factor loadings $\delta_{d,i}$:

```{=tex}
\begin{align}
\varepsilon_{i,t}^{\text{state}}=\sum_{d}^{D}\zeta_{t,d}\delta_{d,i} + I_{ij}\epsilon_{i,t}
\end{align}
```
where $D$ is the number of latent factors, $\epsilon_{i,t} \sim \text{Normal}(0, \sigma_{\epsilon,i}^2)$, and $I_{ij}$ is the identity matrix ($I_{ii}=1$ and $I_{ij, i \ne j} = 0$). With this formulation, the matrix $\pmb{\Omega_{\varepsilon}}$ can be described as $\pmb{\Omega_{\varepsilon}}=\pmb{\Delta}^T\pmb{\Delta} + \text{diag}(\sigma_{\epsilon,i}^2)$, where $\pmb{\Delta}$ is the matrix of factor loadings $\delta_{d,i}$. This model structure has a merit of reduced number of parameters while capturing the correlated nature of environmental noises [@ovaskainenHowAreSpecies2017]. We set $D=2$ when the number of species in a community is greater than four, otherwise $D=1$. We reported the estimates of $\alpha_{ij}$ so the values are comparable to those used in the theoretical analysis.

**Model fitting.** We fitted the models to the data using JAGS version 4.1.0 through *runjags* package version 2.2.0-2 in R [@denwoodRunjagsPackageProviding2016]. We assigned weakly informative priors to parameters (**Table S6**). Four Markov chain Monte Carlo (MCMC) chains were run until parameter estimates converged. The total MCMC iteration was XXX. Convergence was assessed by examining whether the $\hat{R}$ indicator of each parameter approached \< 1.1 [@gelmanDataAnalysisUsing2007]. Data manipulation and analysis were performed in R version 4.2.1 [@rcoreteamLanguageEnvironmentStatistical2021]. Parameter estimates were summarized in **Table S7 -- S10**.

\newpage

# Supplementary Tables

## Table S1 Simulation parameter

Parameter values used in the main and sensitivity analysis. Five hundred parameter values were drawn randomly from uniform distributions in the sensitivity analysis.

```{r table_s1}

# Table S1
source(here::here("code/table_param_set.R"))
knitr::kable(df_param, format = "markdown")

```

\newpage

## Table S2 Observed species

Fish species found in the study watersheds.

```{r table_s5}

# Table S5
source(here::here("code/table_species_list.R"))

knitr::kable(df_sp_list,
             format = "markdown")
```

\newpage

## Table S3 Priors

Prior distributions used in the Bayesian models.

```{r table_s6}

# Table S6
source(here::here("code/table_prior.R"))

knitr::kable(df_prior,
             format = "markdown")

```

\newpage

## Table S4 Parameter estimates of the Bayesian state-space model

Median estimates of the Bayesian state-space model. Numbers in parenthesis indicate 95% credible intervals. Site-specific parameters were excluded due to a large number of parameters.

```{r table_s7}

# Table S7
source(here::here("code/table_ssm.R"))

knitr::kable(df_ssm,
             align = c(rep("l", 3), "c"),
             format = "markdown")

```

\newpage

```{r table_reg}

# Table S8-10
## load regression tables
source(here::here("code/table_reg.R"))
j <- 7

## conditional text
c_text <- case_when(group == "all" ~ "whole community",
                    group == "masu_salmon" ~ "masu salmon",
                    group == "other" ~ "unenhanced species")

## common text
table_legend <- "Median estimates and standard errors (SEs) of regression coefficients are shown. Pr(> 0) and Pr(< 0) represent the proportion of positive and negative estimates in MCMC samples, respectively (i.e., posterior probability)."

table_reg_chunk <- knit_chunk <- NULL

for(i in seq_len(length(list_reg))) {
  
  knit_chunk <- paste0("## Table S", i + j, " Parameter estimates for the regression model (", c_text[i], ") \n",
                       table_legend,
                       "\n```{r table_s", i + j,"}
                       \n\n
                       kable(list_reg[[",i,"]],
                             align = c(rep('l', 3), rep('c', 4)),
                             format = 'markdown')
                       \n\n
                       ```\n",
                       "\n\\pagebreak\n")

  table_reg_chunk <- c(table_reg_chunk, knit_chunk)
  
}


```

`r paste(knitr::knit(text = table_reg_chunk), collapse = '\n')`

# Supplementary Figures

```{r figure_sim}

# Figure S1-6
## load figures
source(here::here("code/si_figure_theory.R"))

j <- 0
figure_sim_chunk <- knit_chunk <- NULL

for(i in seq_len(nrow(df_param))) {
  
  knit_chunk <- paste0("## Figure S", i + j,
                       " Theoretical prediction (",
                       "$r_1$ = `r df_param$r1[",i,"]`, ",
                       "$K$ = `r df_param$k[",i,"]`) \n",
                       
                       "\n```{r figure_s", i + j,", fig.width = 9.5, fig.height = 8}
                       \n\n
                       list_g_theory[[",i,"]]
                       \n\n
                       ```\n",
                       
                       "Theoretical predictions for the release effect on community dynamics. Rows represent different response variables, and columns show distinct simulation scenarios with different strength of interspecific competition ($\\bar{\\alpha}$) and relative fitness of captive-bred individuals ($f_R$). Other parameters are: ",
                       "number of species $S$ = `r df_param$n_species[",i,"]`; ",
                       "intrinsic growth rate of an enhanced species $r_1$ = `r df_param$r1[",i,"]`; ",
                       "maximum intrinsic growth rate of unenhanced species $r_{max}$ = `r df_param$r_max[",i,"]`; ",
                        "environmental stochasticity $\\sigma_{\\varepsilon}$ = `r df_param$sd_env[",i,"]`; ",
                        "carrying capacity $K$ = `r df_param$k[",i,"]`.",
                        "\n\\pagebreak\n")

  figure_sim_chunk <- c(figure_sim_chunk, knit_chunk)
  
}

```

`r paste(knitr::knit(text = figure_sim_chunk), collapse = '\n')`

```{r figure_dyns}

# Figure S7-9
## load figures
source(here::here("code/si_figure_obs_dyns.R"))
j <- 6

c_text <- c("whole community",
            "masu salmon",
            "unenhanced species")

figure_dyns_chunk <- knit_chunk <- NULL

for(i in seq_len(length(list_g_dyns))) {
  
  knit_chunk <- paste0("## Figure S", i + j,
                       " Temporal dynamics of stream fish communities (`r c_text[",i,"]`) \n",
                       
                       "\n```{r figure_s", i + j,", fig.width = 11, fig.height = 11}
                       \n\n
                       list_g_dyns[[",i,"]]
                       \n\n
                       ```\n",
                       "Temporal dynamics of stream fish communities (`r c_text[",i,"]`) in Hokkaido, Japan. Dots represent observed density, and solid lines are the predicted values of the Bayesian state-space model. Panels correspond to individual watersheds, and colors distinguish sampling sites within a watershed.",
                        "\n\\pagebreak\n")

  figure_dyns_chunk <- c(figure_dyns_chunk, knit_chunk)
  
}

```

`r paste(knitr::knit(text = figure_dyns_chunk), collapse = '\n')`

\newpage

## Figure S10 Environmental variables

```{r figure_s10, fig.width=11, fig.height=8}

source(here::here("code/si_figure_env.R"))

print(g_env)
```

Distribution of environmental variables in the protected watershed. Note that the number of fish released and ocean productivity (chlorophyll *a*) are measured at the watershed level while others are measured at the site level.

\newpage

## Figure S11 Correlation plot

```{r figure_s11, fig.width=11, fig.height=11}

source(here::here("code/si_figure_cor.R"))
```

Correlation plot among environmental variables in the protected watersheds. Numbers indicate Spearman's rank correlations.

\newpage

# References
